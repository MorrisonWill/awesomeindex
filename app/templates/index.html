{% extends "base.html" %}

{% block search %}
    <form id="search-form" autocomplete="off">
        <div class="search-box">
            <input type="text" name="q" placeholder="Search projects, tools, libraries..." autocomplete="off"
                   class="search-input" autofocus>
            <button type="button" class="filter-toggle" aria-label="Toggle filters">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="6" x2="20" y2="6"></line>
                    <line x1="4" y1="12" x2="20" y2="12"></line>
                    <line x1="4" y1="18" x2="20" y2="18"></line>
                </svg>
                <span class="filter-toggle-text">Filters</span>
            </button>
        </div>
        <div class="filters" id="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Sort:</label>
                    <select name="sort" class="filter-select">
                        <option value="relevance">Relevance</option>
                        <option value="stars" selected>Most Stars</option>
                        <option value="recent">Recently Updated</option>
                        <option value="name">Alphabetical</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Repository:</label>
                    <select name="repository" class="filter-select repository-filter">
                        <option value="">All repositories</option>
                        {% if filter_options %}
                            {% for repo in filter_options.repositories %}
                                <option value="{{ repo }}">
                                    {% if repo.startswith('awesome-') %}
                                        {{ repo[8:] }}
                                    {% else %}
                                        {{ repo }}
                                    {% endif %}
                                </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Language:</label>
                    <select name="language" class="filter-select language-filter">
                        <option value="">All languages</option>
                        {% if filter_options %}
                            {% for lang in filter_options.languages %}
                                <option value="{{ lang }}">{{ lang }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Category:</label>
                    <select name="category" class="filter-select category-filter">
                        <option value="">All categories</option>
                        {% if filter_options %}
                            {% for cat in filter_options.categories %}
                                <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label>Min stars:</label>
                    <input type="number" name="min_stars" value="0" min="0" class="filter-input" placeholder="0">
                </div>
                <div class="filter-group filter-presets">
                    <button type="button" class="filter-preset" data-preset="clear">Clear Filters</button>
                </div>
            </div>
        </div>
    </form>
{% endblock %}

{% block content %}
    <div id="loading" class="loading htmx-indicator">Loading...</div>

    <!-- Single content area for both search and browse -->
    <div id="content">
        {% if initial_results %}
            <!-- Render initial browse results server-side to avoid flicker -->
            {% with results=initial_results %}
                {% include "search_results.html" %}
            {% endwith %}
        {% else %}
            <div class="no-results" id="welcome">
                <h3>Search thousands of curated open source projects</h3>
                <p>Type to search across all GitHub awesome lists</p>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('#search-form');
            const searchInput = document.querySelector('.search-input');
            const content = document.querySelector('#content');
            const loading = document.querySelector('#loading');
            const filterToggle = document.querySelector('.filter-toggle');
            const filters = document.querySelector('#filters');

            // Toggle filters on mobile
            if (filterToggle) {
                filterToggle.addEventListener('click', () => {
                    filters.classList.toggle('active');
                    filterToggle.setAttribute('aria-expanded',
                        filters.classList.contains('active') ? 'true' : 'false');
                });
            }

            // Function to get form data
            function getFormData() {
                const formData = new FormData(form);
                const params = new URLSearchParams(formData);
                return params.toString();
            }

            // Function to update content
            function updateContent() {
                const query = searchInput.value.trim();
                const params = getFormData();
                const url = query ? `/search?${params}` : `/browse?${params}`;

                // Show loading
                loading.style.display = 'block';

                // Fetch content
                htmx.ajax('GET', url, {
                    target: '#content',
                    swap: 'innerHTML'
                }).then(() => {
                    loading.style.display = 'none';
                });
            }

            // Search input handler (with debounce)
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(updateContent, 300);
            });

            // Filter change handlers
            form.querySelectorAll('.filter-select, .filter-input').forEach(el => {
                el.addEventListener('change', updateContent);
            });

            // Clear filters button
            document.querySelector('.filter-preset[data-preset="clear"]')?.addEventListener('click', () => {
                form.reset();
                form.querySelector('[name="sort"]').value = 'stars';
                searchInput.value = '';
                updateContent();
            });

            // Set default sort
            const sortSelect = form.querySelector('[name="sort"]');
            if (sortSelect && !searchInput.value) {
                sortSelect.value = 'stars';
            }

            // Global function to search by topic
            window.searchTopic = function (topic) {
                searchInput.value = topic;
                updateContent();
            };
        });
    </script>
{% endblock %}
