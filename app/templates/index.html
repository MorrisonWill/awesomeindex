{% extends "base.html" %}

{% block search %}
    <form id="search-form" autocomplete="off"
          hx-get="/results"
          hx-trigger="keyup changed delay:300ms from:input[name='q'], change from:select, change from:input[type='number']"
          hx-target="#content"
          hx-include="this">
        <div class="search-box">
            <input type="text" name="q" placeholder="Search projects, tools, libraries..." autocomplete="off"
                   class="search-input" autofocus>
            <button type="button" class="filter-toggle" aria-label="Toggle filters">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="6" x2="20" y2="6"></line>
                    <line x1="4" y1="12" x2="20" y2="12"></line>
                    <line x1="4" y1="18" x2="20" y2="18"></line>
                </svg>
                <span class="filter-toggle-text">Filters</span>
            </button>
        </div>
        <div class="filters" id="filters">
            <div class="filter-group">
                <label>Sort:</label>
                <select name="sort" class="filter-select">
                    <option value="relevance">Relevance</option>
                    <option value="stars" selected>Stars</option>
                    <option value="recent">Recent</option>
                    <option value="name">A-Z</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Repo:</label>
                <select name="repository" class="filter-select repository-filter">
                    <option value="">All</option>
                    {% if filter_options %}
                        {% for repo in filter_options.repositories %}
                            <option value="{{ repo }}">
                                {% if repo.lower().startswith('awesome-') %}
                                    {{ repo[8:] }}
                                {% else %}
                                    {{ repo }}
                                {% endif %}
                            </option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="filter-group">
                <label>Lang:</label>
                <select name="language" class="filter-select language-filter">
                    <option value="">All</option>
                    {% if filter_options %}
                        {% for lang in filter_options.languages %}
                            <option value="{{ lang }}">{{ lang }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="filter-group">
                <label>Category:</label>
                <select name="category" class="filter-select category-filter">
                    <option value="">All</option>
                    {% if filter_options %}
                        {% for cat in filter_options.categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="filter-group">
                <label>Min â˜…:</label>
                <input type="number" name="min_stars" value="0" min="0" class="filter-input" placeholder="0">
            </div>
            <div class="filter-group filter-presets">
                <button type="button" class="filter-preset" data-preset="clear">Clear</button>
            </div>
        </div>
    </form>
{% endblock %}

{% block content %}
    <div id="loading" class="loading htmx-indicator">Loading...</div>

    <!-- Single content area for both search and browse -->
    <div id="content" hx-indicator="#loading">
        {% if initial_results %}
            <!-- Render initial browse results server-side to avoid flicker -->
            {% with results=initial_results, query=query, next_offset=next_offset, filters=filters %}
                {% include "results.html" %}
            {% endwith %}
        {% else %}
            <div class="no-results" id="welcome">
                <h3>Search thousands of curated open source projects</h3>
                <p>Type to search across all GitHub awesome lists</p>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const filterToggle = document.querySelector('.filter-toggle');
            const filters = document.querySelector('#filters');

            // Toggle filters on mobile
            if (filterToggle) {
                filterToggle.addEventListener('click', () => {
                    filters.classList.toggle('active');
                    filterToggle.setAttribute('aria-expanded',
                        filters.classList.contains('active') ? 'true' : 'false');
                });
            }

            // Clear filters button
            const clearBtn = document.querySelector('.filter-preset[data-preset="clear"]');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    const form = document.querySelector('#search-form');
                    form.reset();
                    form.querySelector('[name="sort"]').value = 'stars';
                    // Trigger HTMX to update results
                    htmx.trigger(form, 'submit');
                });
            }

            // Global function to search by topic
            window.searchTopic = function (topic) {
                const searchInput = document.querySelector('.search-input');
                searchInput.value = topic;
                // Trigger HTMX to update results
                htmx.trigger(searchInput, 'keyup');
            };
        });
    </script>
{% endblock %}
