{% extends "base.html" %}

{% block search %}
    <form id="search-form">
        <div class="search-box">
            <input type="text" name="q" placeholder="Search projects, tools, libraries..." autocomplete="off"
                   class="search-input" autofocus>
            <div class="search-hint">
                <span>Press</span>
                <kbd class="kbd">/</kbd>
                <span>to search</span>
            </div>
        </div>
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Sort:</label>
                    <select name="sort" class="filter-select">
                        <option value="relevance">Relevance</option>
                        <option value="stars" selected>Most Stars</option>
                        <option value="recent">Recently Updated</option>
                        <option value="name">Alphabetical</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Repository:</label>
                    <select name="repository" class="filter-select repository-filter">
                        <option value="">All repositories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Language:</label>
                    <select name="language" class="filter-select language-filter">
                        <option value="">All languages</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Category:</label>
                    <select name="category" class="filter-select category-filter">
                        <option value="">All categories</option>
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label>Min stars:</label>
                    <input type="number" name="min_stars" value="0" min="0" class="filter-input" placeholder="0">
                </div>
                <div class="filter-group">
                    <label>Topics:</label>
                    <input type="text" name="topics" class="filter-input" style="width: 200px"
                           placeholder="e.g. api, testing">
                </div>
                <div class="filter-group filter-presets">
                    <button type="button" class="filter-preset" data-preset="clear">Clear Filters</button>
                </div>
            </div>
        </div>
    </form>
{% endblock %}

{% block content %}
    <div id="loading" class="loading htmx-indicator">Loading...</div>

    <!-- Single content area for both search and browse -->
    <div id="content" hx-get="/browse" hx-trigger="load delay:100ms" hx-swap="innerHTML">
        <div class="no-results" id="welcome">
            <h3>Search thousands of curated open source projects</h3>
            <p>Type to search across all GitHub awesome lists</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('#search-form');
            const searchInput = document.querySelector('.search-input');
            const content = document.querySelector('#content');
            const loading = document.querySelector('#loading');

            // Function to get form data
            function getFormData() {
                const formData = new FormData(form);
                const params = new URLSearchParams(formData);
                return params.toString();
            }

            // Function to update content
            function updateContent() {
                const query = searchInput.value.trim();
                const params = getFormData();
                const url = query ? `/search?${params}` : `/browse?${params}`;

                // Show loading
                loading.style.display = 'block';

                // Fetch content
                htmx.ajax('GET', url, {
                    target: '#content',
                    swap: 'innerHTML'
                }).then(() => {
                    loading.style.display = 'none';
                });
            }

            // Search input handler (with debounce)
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(updateContent, 300);
            });

            // Filter change handlers
            form.querySelectorAll('.filter-select, .filter-input').forEach(el => {
                el.addEventListener('change', updateContent);
            });

            // Clear filters button
            document.querySelector('.filter-preset[data-preset="clear"]')?.addEventListener('click', () => {
                form.reset();
                form.querySelector('[name="sort"]').value = 'stars';
                searchInput.value = '';
                updateContent();
            });

            // Set default sort
            const sortSelect = form.querySelector('[name="sort"]');
            if (sortSelect && !searchInput.value) {
                sortSelect.value = 'stars';
            }

            // Global function to search by topic
            window.searchTopic = function (topic) {
                searchInput.value = topic;
                updateContent();
            };
        });
    </script>
{% endblock %}
